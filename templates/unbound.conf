{{ ansible_managed | comment }}

{%- macro render_dict(dictionary) -%}
{%- for key, value in dictionary.items() | list -%}
    {%- set key = key|replace("_", "-") -%}

        {#- Fix: error for cert file: certificate.pem #}
        {#- error in SSL_CTX use_certificate_file crypto error:02001002:system library:fopen:No such file or directory #}
        {%- if key == 'ssl-service-key' or key == 'ssl-service-pem' %}

    {{key}}: {{unbound.server.directory}}/{{value}}
        {%- elif value|string == "1" or value|string == "0" %}

    {{key}}: {{value}}
        {%- elif value == True %}

    {{key}}: yes
        {%- elif value == False %}

    {{key}}: no
        {%- elif value == none %}

    {{key}}: ""
        {%- elif value|string == "" %}

    {{key}}: {{ '""' }}
        {%- elif value is iterable and value is not string %}
        {%- for item in value %}

    {{key}}: {{item}}
        {%- endfor -%}
        {%- else %}

    {{key}}: {{value}}
        {%- endif %}
    {%- endfor %}
{%- endmacro %}

# See unbound.conf(5) man page.
# https://www.unbound.net/documentation/unbound.conf.html
#
# Use this to include other text into the file.
# include: "otherfile.conf"
{% if unbound is defined -%}
{%- for unbound_clause, clause_values in unbound.items() | list -%}
{%- set unbound_clause = unbound_clause|replace("_", "-") %}

{{unbound_clause}}:

    {%- if unbound_optimise is defined and unbound_optimise and unbound_clause == 'server' %}
    {%- set threads = ansible_processor_cores|default(1) * ansible_processor_count|default(1) %}

    # http://unbound.nlnetlabs.nl/documentation/howto_optimise.html
    # https://unbound.net/pipermail/unbound-users/2010-March/001083.html
    # https://github.com/jedisct1/dnscrypt-server-docker/blob/master/unbound.sh
    {#- divide by user percentage and divide by number of caches and * 0.75 for malloc overhead and for kernal and other services #}
    {%- set memoryMB = ansible_memtotal_mb|default(512) | int * unbound_optimise_memory // 100 // 4 * 0.75 %}
    {%- set memory = memoryMB|round|int %}

    {# use all CPUs -#}
    num-threads: {{ threads }}
    {# power of 2 close to num-threads (e.g. 1, 2, 4, 8, 16) -#}
    msg-cache-slabs: {{ threads }}
    rrset-cache-slabs: {{ threads }}
    key-cache-slabs: {{ threads }}
    infra-cache-slabs: {{ threads }}
    # dnscrypt-shared-secret-cache-slabs: {{ threads }}
    # dnscrypt-nonce-cache-slabs:{{ threads }}

    msg-cache-size: {{ memory }}m # default 4m
    rrset-cache-size: {{ memory * 2 }}m # rrset=msg*2 # default 4m
    key-cache-size: {{ memory }}m # default 4m
    neg-cache-size: {{ memory // 2 }}m # default 1m
    infra-cache-numhosts: 50000
    # dnscrypt-shared-secret-cache-size: {{ memory // 4 }}m # default 4m
    # dnscrypt-nonce-cache-size:: {{ memory // 4 }}m # default 4m
    {% endif -%}

    {%- if opennic_tlds is defined and unbound_clause == 'server' %}

    domain-insecure: "dns.opennic.glue"
    {%- for tld in opennic_tlds if tld != '.' %}

    domain-insecure: "{{tld}}"
    {%- endfor -%}
    {% endif -%}

    {%- if clause_values.items is defined -%}
    {{ render_dict(clause_values) }}
    {%- else %}
    {%- for stuff in clause_values -%}
    {%- if not loop.first %}

{{unbound_clause}}:
    {%- endif -%}
    {{ render_dict(stuff) }}
    {%- endfor -%}
    {%- endif -%}

{%- endfor -%}
{%- endif %}

{#
# {% if opennic is defined and opennic %}
# # Stub zones.
# stub-zone:
#     name: "dns.opennic.glue"
#     stub-addr: "127.0.0.1@{{nsd_port}}"

# {% for tld in opennic_tlds if tld != '.' %}
# stub-zone:
#     name: "{{tld}}"
#     stub-addr: "127.0.0.1@{{nsd_port}}"

# {% endfor -%}
# {% endif %}

# Forward zones
# forward-zone:
#     name: "."
#     forward-addr: 8.8.4.4        # Google
#     forward-addr: 8.8.8.8        # Google
#     forward-addr: 208.67.222.220 # OpenDNS
#     forward-addr: 208.67.222.222 # OpenDNS
#     forward-addr: 50.116.23.211  # OpenNIC
#     forward-addr: 216.146.35.35  # Dyn Public
#     forward-addr: 216.146.36.36  # Dyn Public
#     forward-addr: 64.6.64.6      # Verisign
#     forward-addr: 64.6.65.6      # Verisign
#     forward-addr: 37.235.1.174   # FreeDNS
#     forward-addr: 37.235.1.177   # FreeDNS
#     forward-addr: 84.200.69.80   # DNS Watch
#     forward-addr: 84.200.70.40   # DNS Watch
#     forward-addr: 74.82.42.42    # Hurricane Electric
#     forward-addr: 91.239.100.100 # censurfridns.dk
#     forward-addr: 109.69.8.51    # puntCAT
#}
