{{ ansible_managed | comment }}

# See unbound.conf(5) man page.
# https://www.unbound.net/documentation/unbound.conf.html
#
# Use this to include other text into the file.
# include: "otherfile.conf"

{%- if dns_over_tls is defined -%}
    ssl-service-key: {{ unbound_tls.private_key }}
    ssl-service-pem: {{ unbound_tls.cert }}
    ssl-port: {{ unbound_tls.port }}
{%- endif %}

{% if unbound is defined -%}
{%- for unbound_clause, clause_values in unbound.iteritems() -%}
{%- set unbound_clause = unbound_clause|replace("_", "-") %}

{{unbound_clause}}:

    {%- if optimise is defined and optimise and unbound_clause == 'server' %}

    # use all CPUs
    num-threads: {{ threads.stdout }}
    # power of 2 close to num-threads (e.g. 1, 2, 4, 8, 16)
    msg-cache-slabs: {{ threads.stdout }}
    rrset-cache-slabs: {{ threads.stdout }}
    key-cache-slabs: {{ threads.stdout }}
    infra-cache-slabs: {{ threads.stdout }}
    # convert bytes to Mebibytes: 1 Mebibyte = 2^20 = 1024*1024 = 1048576 bytes
    msg-cache-size: {{ cache_memory.stdout | int // 2**20 // 4}}m
    rrset-cache-size: {{ cache_memory.stdout | int // 2**20 // 4 * 2 }}m # rrset=msg*2
    key-cache-size: {{ cache_memory.stdout | int // 2**20 // 4 // 2 }}m
    {%- endif -%}

    {%- for key, value in clause_values.iteritems() -%}
    {%- set key = key|replace("_", "-") -%}
    {%- if value|string == "1" or value|string == "0" %}

    {{key}}: {{value}}
        {%- elif value == True %}

    {{key}}: yes
        {%- elif value == False %}

    {{key}}: no
        {%- elif value == none %}

    {{key}}: ""
        {%- elif value|string == "" %}

    {{key}}: {{ '""' }}
        {%- elif value is iterable and value is not string %}
        {%- for item in value %}

    {{key}}: {{item}}
        {%- endfor -%}
        {%- else %}

    {{key}}: {{value}}
    {%- endif -%}
    {%- endfor %}

{% endfor -%}
{%- endif %}

# {% if opennic is defined and opennic -%}
#     domain-insecure: "dns.opennic.glue"
# {% for tld in tlds.stdout_lines if tld != '.' %}
#     domain-insecure: "{{tld}}"
# {% endfor -%}
# {%- endif %}

# {% if opennic is defined and opennic%}
# # Stub zones.
# stub-zone:
#     name: "dns.opennic.glue"
#     stub-addr: "127.0.0.1@{{nsd_port}}"

# {% for tld in tlds.stdout_lines if tld != '.' %}
# stub-zone:
#     name: "{{tld}}"
#     stub-addr: "127.0.0.1@{{nsd_port}}"

# {% endfor -%}
# {% endif %}

# Forward zones
# forward-zone:
#     name: "."
#     forward-addr: 8.8.4.4        # Google
#     forward-addr: 8.8.8.8        # Google
#     forward-addr: 208.67.222.220 # OpenDNS
#     forward-addr: 208.67.222.222 # OpenDNS
#     forward-addr: 50.116.23.211  # OpenNIC
#     forward-addr: 216.146.35.35  # Dyn Public
#     forward-addr: 216.146.36.36  # Dyn Public
#     forward-addr: 64.6.64.6      # Verisign
#     forward-addr: 64.6.65.6      # Verisign
#     forward-addr: 37.235.1.174   # FreeDNS
#     forward-addr: 37.235.1.177   # FreeDNS
#     forward-addr: 84.200.69.80   # DNS Watch
#     forward-addr: 84.200.70.40   # DNS Watch
#     forward-addr: 74.82.42.42    # Hurricane Electric
#     forward-addr: 91.239.100.100 # censurfridns.dk
#     forward-addr: 109.69.8.51    # puntCAT
